# ABOUTME: Docker Compose definition for the full agentic observability sandbox (11 services).
# ABOUTME: Defines agent-net, observability-net, and frontend-net with security hardening.

networks:
  agent-net:
    internal: true
  observability-net: {}
  frontend-net: {}

volumes:
  grafana-data:
  loki-data:
  prom-data:

services:
  # ---------- Frontend ----------
  web:
    build: ./services/web
    ports:
      - "${WEB_PORT:-3001}:3000"
    networks:
      - frontend-net
      - observability-net

  # ---------- Agent core ----------
  agent:
    build: ./services/agent
    networks:
      - agent-net
    cap_drop:
      - ALL
    read_only: true
    mem_limit: 2g
    cpus: 2
    tmpfs:
      - /tmp
    environment:
      - MCP_PROXY_URL=http://mcp-proxy:8001
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_SERVICE_NAME=agent
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - mcp-proxy

  mcp-server:
    build: ./services/mcp-server
    networks:
      - agent-net
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_SERVICE_NAME=mcp-server

  mcp-proxy:
    build: ./services/mcp-proxy
    ports:
      - "${MCP_PROXY_PORT:-8001}:8001"
    networks:
      - agent-net
      - observability-net
    environment:
      - MCP_SERVER_URL=http://mcp-server:8000
      - OPA_URL=http://opa:8181
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_SERVICE_NAME=mcp-proxy
    depends_on:
      - mcp-server
      - opa
      - otel-collector

  # ---------- Policy ----------
  opa:
    image: openpolicyagent/opa:0.61.0
    command: run --server --log-level debug /policies
    ports:
      - "${OPA_PORT:-8181}:8181"
    networks:
      - agent-net
    volumes:
      - ./policies:/policies:ro

  # ---------- Observability ----------
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.96.0
    ports:
      - "${OTEL_GRPC_PORT:-4317}:4317"
      - "${OTEL_HTTP_PORT:-4318}:4318"
    networks:
      - observability-net
      - agent-net
    volumes:
      - ./config/otel-collector.yaml:/etc/otelcol-contrib/config.yaml:ro

  jaeger:
    image: jaegertracing/all-in-one:1.54
    ports:
      - "${JAEGER_PORT:-16686}:16686"
    networks:
      - observability-net
    environment:
      - COLLECTOR_OTLP_ENABLED=true

  grafana:
    image: grafana/grafana:10.3.1
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    networks:
      - observability-net
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD:-admin}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro

  loki:
    image: grafana/loki:2.9.4
    ports:
      - "${LOKI_PORT:-3100}:3100"
    networks:
      - observability-net
    volumes:
      - ./config/loki.yaml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki

  prometheus:
    image: prom/prometheus:v2.49.1
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    networks:
      - observability-net
    volumes:
      - ./config/prometheus.yaml:/etc/prometheus/prometheus.yml:ro
      - prom-data:/prometheus

  promtail:
    image: grafana/promtail:2.9.4
    networks:
      - observability-net
    volumes:
      - ./config/promtail.yaml:/etc/promtail/config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
